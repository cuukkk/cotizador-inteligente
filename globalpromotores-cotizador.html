<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Promotores | Cotizador</title>
<style>
:root{
  --blue:#1F5FAF;--blue-dark:#163E73;--blue-accent:#2E78D6;
  --black:#111111;--gray:#5E6A75;--bg:#F4F6F8;
  --success:#2E7D32;--error:#C62828;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui;}
body{background:#fff;color:var(--black);}
.container{max-width:1100px;margin:auto;padding:24px;}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 0;}
header img{height:56px;}
h1{font-size:2rem;margin-bottom:4px;}
p.lead{color:var(--gray);}
.section{background:var(--bg);border-radius:8px;padding:20px;margin:14px 0;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
label{display:block;font-weight:600;margin-bottom:6px;}
input,select,textarea{
  width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;
}
button{
  background:var(--blue);color:#fff;border:none;border-radius:8px;
  padding:14px;font-weight:700;cursor:pointer;
}
button:hover{background:var(--blue-dark);}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;}
.actions button{flex:1;min-width:200px;}
.small{font-size:12px;color:var(--gray);}
.hidden{display:none;}
.status{font-weight:700;}
.status.ok{color:var(--success);}
.status.err{color:var(--error);}

/* Modal */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;
  align-items:center;justify-content:center;padding:20px;z-index:50;
}
.modal{
  background:#fff;border-radius:12px;padding:20px;max-width:600px;width:100%;
}
.modal h3{margin-bottom:10px;}
.modal .actions{margin-top:16px;}
@media(max-width:800px){
  .grid{grid-template-columns:1fr;}
  header{flex-direction:column;align-items:flex-start;}
  .actions button{width:100%;}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Cotizador Inteligente de Seguros</h1>
      <p class="lead">Captura datos, valida y cotiza tu seguro de auto.</p>
    </div>
    <img src="logo.png" alt="Global Promotores Seguros">
  </header>

  <div class="section">
    <h2>Datos personales</h2>
    <div class="grid">
      <div><label>Nombre completo *</label><input id="nombre" required></div>
      <div><label>Edad *</label><input id="edad" type="number" min="18" max="80" required></div>
      <div><label>CP *</label><input id="cp" maxlength="5" required><div id="cpStatus" class="small"></div></div>
      <div><label>Teléfono *</label><input id="telefono" required></div>
      <div><label>Email *</label><input id="email" type="email" required></div>
    </div>
  </div>

  <div class="section">
    <h2>Vehículo</h2>
    <div class="grid">
      <div><label>Año *</label><input id="year" type="number" min="1990" max="2026" required></div>
      <div><label>Marca *</label><input id="make" required></div>
      <div>
        <label>Modelo *</label>
        <select id="model"><option value="">Buscar modelo</option></select>
        <button type="button" onclick="loadModels()">Buscar modelos</button>
      </div>
      <div><label>Versión *</label><input id="version" required></div>
    </div>
  </div>

  <div class="section">
    <h2>Validaciones</h2>
    <div>
      <label><input type="checkbox" id="brokerCheck"> Soy corredor con cédula</label>
      <input id="brokerId" class="hidden" placeholder="Cédula del corredor">
    </div>
    <div>
      <label><input type="checkbox" id="cardCheck"> Subir tarjeta de circulación</label>
      <input id="cardFile" type="file" class="hidden" accept="image/*">
      <div id="cardLink" class="small"></div>
    </div>
    <div>
      <label><input type="checkbox" id="nivCheck"> Subir foto de NIV</label>
      <input id="nivFile" type="file" class="hidden" accept="image/*">
      <div id="nivLink" class="small"></div>
    </div>
    <div>
      <label>Serie/NIV (opcional)</label>
      <input id="nivText" placeholder="17 caracteres">
    </div>
  </div>

  <div class="section">
    <h2>Enviar</h2>
    <div class="actions">
      <button type="button" onclick="openSummary()">Guardar y enviar</button>
    </div>
    <div id="sendStatus" class="status"></div>
  </div>
</div>

<!-- Modal resumen -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>Resumen</h3>
    <div id="summary"></div>
    <div class="actions">
      <button type="button" onclick="submitLead()">Enviar</button>
      <button type="button" onclick="closeModal()">Corregir</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="REEMPLAZA_SUPABASE_URL";
const SUPABASE_ANON="REEMPLAZA_SUPABASE_ANON";

document.getElementById("brokerCheck").addEventListener("change", e=>{
  document.getElementById("brokerId").classList.toggle("hidden", !e.target.checked);
});
document.getElementById("cardCheck").addEventListener("change", e=>{
  document.getElementById("cardFile").classList.toggle("hidden", !e.target.checked);
});
document.getElementById("nivCheck").addEventListener("change", e=>{
  document.getElementById("nivFile").classList.toggle("hidden", !e.target.checked);
});

document.getElementById("cp").addEventListener("blur", validateCP);

async function validateCP(){
  const cp = document.getElementById("cp").value.trim();
  if(cp.length !== 5){ setCP("CP inválido", false); return; }
  try{
    const res = await fetch(`https://sepomex.icalialabs.com/api/v1/zip_codes?zip_code=${cp}`);
    const data = await res.json();
    if(data && data.zip_codes && data.zip_codes.length>0) setCP("CP válido", true);
    else setCP("CP no encontrado", false);
  }catch(e){ setCP("Error validando CP", false); }
}
function setCP(msg, ok){
  const el = document.getElementById("cpStatus");
  el.textContent = msg;
  el.className = ok ? "status ok" : "status err";
}

async function loadModels(){
  const make = document.getElementById("make").value.trim().toLowerCase();
  const year = document.getElementById("year").value.trim();
  if(!make || !year) return alert("Completa marca y año");
  const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/GetModelsForMakeYear/make/${make}/modelyear/${year}?format=json`);
  const data = await res.json();
  const sel = document.getElementById("model");
  sel.innerHTML = `<option value="">Selecciona modelo</option>`;
  data.Results.slice(0,50).forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m.Model_Name;
    opt.textContent = m.Model_Name;
    sel.appendChild(opt);
  });
}

function getForm(){
  return {
    nombre: v("nombre"), edad: v("edad"), cp: v("cp"),
    telefono: v("telefono"), email: v("email"),
    year: v("year"), make: v("make"), model: v("model"),
    version: v("version"), broker: c("brokerCheck"),
    broker_id: v("brokerId"), niv: v("nivText"),
    card_url: window._cardUrl || "",
    niv_url: window._nivUrl || ""
  };
}
function v(id){ return document.getElementById(id).value.trim(); }
function c(id){ return document.getElementById(id).checked; }

function openSummary(){
  const d = getForm();
  document.getElementById("summary").innerHTML = `
    <b>${d.nombre}</b> (${d.edad})<br/>
    CP: ${d.cp} | Tel: ${d.telefono} | Email: ${d.email}<br/>
    Auto: ${d.year} ${d.make} ${d.model} ${d.version}<br/>
    Corredor: ${d.broker ? "Sí" : "No"} ${d.broker_id || ""}<br/>
    NIV: ${d.niv || "No"}<br/>
    Tarjeta: ${d.card_url ? "Sí" : "No"} | Foto NIV: ${d.niv_url ? "Sí" : "No"}
  `;
  document.getElementById("modalBg").style.display="flex";
}
function closeModal(){ document.getElementById("modalBg").style.display="none"; }

async function uploadFile(file, prefix){
  const filename = `${prefix}_${Date.now()}_${file.name}`;
  const url = `${SUPABASE_URL}/storage/v1/object/leads/${filename}`;
  const res = await fetch(url,{
    method:"POST",
    headers:{
      "apikey": SUPABASE_ANON,
      "Authorization": `Bearer ${SUPABASE_ANON}`,
      "x-upsert":"true"
    },
    body: file
  });
  if(!res.ok) throw new Error("Upload failed");
  return `${SUPABASE_URL}/storage/v1/object/public/leads/${filename}`;
}

document.getElementById("cardFile").addEventListener("change", async e=>{
  if(!e.target.files[0]) return;
  const url = await uploadFile(e.target.files[0],"tarjeta");
  window._cardUrl = url;
  document.getElementById("cardLink").textContent = "Tarjeta cargada ✔";
});
document.getElementById("nivFile").addEventListener("change", async e=>{
  if(!e.target.files[0]) return;
  const url = await uploadFile(e.target.files[0],"niv");
  window._nivUrl = url;
  document.getElementById("nivLink").textContent = "NIV cargado ✔";
});

async function submitLead(){
  closeModal();
  const d = getForm();
  const res = await fetch("/.netlify/functions/lead",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(d)
  });
  const status = document.getElementById("sendStatus");
  if(res.ok){ status.textContent="Enviado (pago pendiente)"; status.className="status ok"; }
  else { status.textContent="Error al enviar"; status.className="status err"; }
}
</script>
</body>
</html>
