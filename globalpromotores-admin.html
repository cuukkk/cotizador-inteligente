<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Global Promotores | Admin</title>
<style>
:root{
  --blue:#1F5FAF;--blue-dark:#163E73;--blue-accent:#2E78D6;
  --black:#111111;--gray:#5E6A75;--gray-light:#F4F6F8;
  --success:#2E7D32;--error:#C62828;--warn:#ED6C02;
}
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0;}
body{background:#fff;color:var(--black);}
.container{max-width:1200px;margin:auto;padding:24px;}
h1{font-size:2rem;}
.card{background:var(--gray-light);border-radius:8px;padding:16px;margin:12px 0;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;}
button{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer;}
button:hover{background:var(--blue-dark);}
input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;}
.small{font-size:12px;color:var(--gray);}
table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;}
</style>
</head>
<body>
<div class="container">
  <h1>Admin | Global Promotores</h1>
  <div class="card">
    <label>Clave admin</label>
    <input id="adminKey" type="password" />
    <button onclick="loadDashboard()">Entrar</button>
  </div>

  <div id="dashboard" class="hidden">
    <div class="card">
      <h2>Funnel</h2>
      <div id="funnel" class="grid"></div>
    </div>

    <div class="card">
      <h2>Leads</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Nombre</th><th>Auto</th><th>Status</th><th>Acción</th></tr>
        </thead>
        <tbody id="leadRows"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Configuración de emails</h2>
      <div class="grid">
        <div><label>Email destino</label><input id="emailTo"/></div>
        <div><label>Email remitente</label><input id="emailFrom"/></div>
      </div>
      <button onclick="saveSettings()">Guardar</button>
    </div>

    <div class="card">
      <h2>Catálogos</h2>
      <div class="grid">
        <div>
          <label>Aseguradoras (1 por línea)</label>
          <textarea id="insurers" rows="6"></textarea>
        </div>
        <div>
          <label>Coberturas (1 por línea)</label>
          <textarea id="coverages" rows="6"></textarea>
        </div>
      </div>
      <button onclick="saveCatalogs()">Guardar</button>
    </div>

    <div class="card" id="leadDetail"></div>
  </div>
</div>

<script>
async function api(action, payload={}){
  const key = document.getElementById("adminKey").value;
  const res = await fetch("/.netlify/functions/admin",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-admin-key": key
    },
    body: JSON.stringify({action, ...payload})
  });
  return res.json();
}

async function loadDashboard(){
  document.getElementById("dashboard").classList.remove("hidden");
  await loadFunnel();
  await loadLeads();
  await loadSettings();
  await loadCatalogs();
}

async function loadFunnel(){
  const data = await api("metrics");
  const funnel = document.getElementById("funnel");
  funnel.innerHTML = `
    <div class="card">Inician: ${data.started}</div>
    <div class="card">Guardan: ${data.saved}</div>
    <div class="card">Envían: ${data.submitted}</div>
    <div class="card">Editan: ${data.edited}</div>
  `;
}

async function loadLeads(){
  const data = await api("list_leads");
  const tbody = document.getElementById("leadRows");
  tbody.innerHTML = "";
  data.forEach(l=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(l.created_at).toLocaleDateString()}</td>
      <td>${l.nombre}</td>
      <td>${l.year} ${l.make} ${l.model}</td>
      <td>${l.status}</td>
      <td><button onclick="viewLead('${l.id}')">Ver</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function viewLead(id){
  const l = await api("get_lead",{id});
  const div = document.getElementById("leadDetail");
  div.innerHTML = `
    <h2>Detalle</h2>
    <p>${l.nombre} | ${l.telefono} | ${l.email}</p>
    <p>${l.year} ${l.make} ${l.model} ${l.version}</p>
    <p>Tarjeta: ${l.card_url ? `<a href="${l.card_url}" target="_blank">ver</a>`:"no"}</p>
    <p>NIV: ${l.niv_url ? `<a href="${l.niv_url}" target="_blank">ver</a>`:"no"}</p>
    <label>Compañía</label><input id="u_insurer" value="${l.insurer||""}"/>
    <label>Cobertura</label><input id="u_cover" value="${l.cobertura||""}"/>
    <label>Monto total</label><input id="u_total" value="${l.monto_total||""}"/>
    <label>Meses cobertura</label><input id="u_months" value="${l.meses_cobertura||""}"/>
    <button onclick="saveLead('${l.id}')">Guardar y enviar</button>
  `;
}

async function saveLead(id){
  await api("update_lead",{
    id,
    insurer: document.getElementById("u_insurer").value,
    cobertura: document.getElementById("u_cover").value,
    monto_total: document.getElementById("u_total").value,
    meses_cobertura: document.getElementById("u_months").value
  });
  alert("Guardado");
  loadLeads();
}

async function loadSettings(){
  const s = await api("get_settings");
  document.getElementById("emailTo").value = s.email_to || "";
  document.getElementById("emailFrom").value = s.email_from || "";
}
async function saveSettings(){
  await api("set_settings",{
    email_to: document.getElementById("emailTo").value,
    email_from: document.getElementById("emailFrom").value
  });
  alert("Guardado");
}
async function loadCatalogs(){
  const c = await api("get_catalogs");
  document.getElementById("insurers").value = c.insurers.join("\n");
  document.getElementById("coverages").value = c.coverages.join("\n");
}
async function saveCatalogs(){
  await api("set_catalogs",{
    insurers: document.getElementById("insurers").value.split("\n").filter(Boolean),
    coverages: document.getElementById("coverages").value.split("\n").filter(Boolean)
  });
  alert("Guardado");
}
</script>
</body>
</html>
